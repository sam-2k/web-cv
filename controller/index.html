<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON CRUD Operations</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        background: linear-gradient(135deg, #00f0ff 0%, #ff00aa 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }

      button {
        background-color: #00f0ff;
        color: #0a0a0f;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button:hover:not(:disabled) {
        background-color: #00c4d1;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      button.delete-btn {
        background-color: #ff00aa;
        color: white;
      }

      button.delete-btn:hover:not(:disabled) {
        background-color: #d4008f;
      }

      button.edit-btn {
        background-color: #f0ff00;
        color: #0a0a0f;
      }

      button.edit-btn:hover:not(:disabled) {
        background-color: #d9e600;
      }

      .section {
        background-color: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }

      h2 {
        color: #0a0a0f;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #00f0ff;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .json-view {
        background-color: #1a1a24;
        color: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        overflow-x: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        max-height: 500px;
        overflow-y: auto;
      }

      .data-section {
        margin-bottom: 25px;
      }

      .data-item {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #00f0ff;
      }

      .data-item h3 {
        color: #0a0a0f;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .data-item p {
        margin-bottom: 8px;
        color: #555;
      }

      .form-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .form-container {
        background-color: white;
        width: 90%;
        max-width: 600px;
        border-radius: 10px;
        padding: 30px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        color: #777;
        cursor: pointer;
        padding: 0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        display: none;
      }

      .notification.success {
        background-color: #4caf50;
      }

      .notification.error {
        background-color: #f44336;
      }

      .notification.warning {
        background-color: #ff9800;
      }

      .icon {
        font-size: 1.2rem;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        font-size: 1.2rem;
        color: #666;
      }

      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 3px solid #ddd;
        border-top-color: #00f0ff;
        border-radius: 50%;
        margin-left: 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .control-panel {
          justify-content: center;
        }

        .data-item h3 {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .item-actions {
          align-self: flex-end;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>JSON CRUD Operations</h1>
        <p class="subtitle">Manage resume data with live file system updates</p>
      </header>

      <div class="control-panel">
        <button id="viewJsonBtn">
          <i class="fas fa-code icon"></i> View Full JSON
        </button>
        <button id="addSkillBtn">
          <i class="fas fa-plus-circle icon"></i> Add Skill
        </button>
        <button id="addExperienceBtn">
          <i class="fas fa-briefcase icon"></i> Add Experience
        </button>
        <button id="addProjectBtn">
          <i class="fas fa-project-diagram icon"></i> Add Project
        </button>
        <button id="resetDataBtn" class="delete-btn">
          <i class="fas fa-undo icon"></i> Reset Data
        </button>
        <button id="exportJsonBtn">
          <i class="fas fa-download icon"></i> Export JSON
        </button>
      </div>

      <div class="section" id="contentSection">
        <div id="loadingIndicator" class="loading">
          Loading data from server...
        </div>

        <div id="dataContent" style="display: none">
          <h2><i class="fas fa-user"></i> Personal Information</h2>
          <div id="personalInfo" class="data-section"></div>

          <h2><i class="fas fa-star"></i> Skills</h2>
          <div id="skillsList" class="data-section"></div>

          <h2><i class="fas fa-briefcase"></i> Experience</h2>
          <div id="experienceList" class="data-section"></div>

          <h2><i class="fas fa-project-diagram"></i> Projects</h2>
          <div id="projectsList" class="data-section"></div>
        </div>
      </div>

      <div class="section" id="jsonViewSection" style="display: none">
        <div class="form-header">
          <h2><i class="fas fa-code"></i> Full JSON Data</h2>
          <button class="close-btn" id="closeJsonBtn">&times;</button>
        </div>
        <pre id="jsonOutput" class="json-view"></pre>
      </div>
    </div>

    <!-- Add/Edit Form Modal -->
    <div class="form-modal" id="formModal">
      <div class="form-container">
        <div class="form-header">
          <h2 id="formTitle">Add Item</h2>
          <button class="close-btn" id="closeFormBtn">&times;</button>
        </div>
        <form id="dataForm">
          <div id="formFields">
            <!-- Dynamic form fields will be inserted here -->
          </div>
          <div class="form-actions">
            <button type="button" class="delete-btn" id="cancelBtn">
              Cancel
            </button>
            <button type="submit" id="submitBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
      // Global data variables
      let jsonData = {};
      let originalData = {};

      // DOM Elements
      const personalInfoEl = document.getElementById("personalInfo");
      const skillsListEl = document.getElementById("skillsList");
      const experienceListEl = document.getElementById("experienceList");
      const projectsListEl = document.getElementById("projectsList");
      const jsonOutputEl = document.getElementById("jsonOutput");
      const jsonViewSection = document.getElementById("jsonViewSection");
      const formModal = document.getElementById("formModal");
      const formTitle = document.getElementById("formTitle");
      const formFields = document.getElementById("formFields");
      const dataForm = document.getElementById("dataForm");
      const notification = document.getElementById("notification");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const dataContent = document.getElementById("dataContent");

      // State variables
      let currentOperation = "add";
      let currentDataType = "";
      let currentItemId = "";

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        loadData();
        setupEventListeners();
      });

      // Load data from server
      async function loadData() {
        try {
          const url = new URL("/api/json/", "http://localhost:3001");
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          jsonData = await response.json();
          originalData = JSON.parse(JSON.stringify(jsonData));

          // Hide loading, show content
          loadingIndicator.style.display = "none";
          dataContent.style.display = "block";

          renderData();
          showNotification("Data loaded successfully!", "success");
        } catch (error) {
          console.error("Error loading data:", error);
          loadingIndicator.innerHTML =
            "Failed to load data. Using empty template.";
          loadingIndicator.style.color = "#f44336";

          // Fallback to empty structure
          jsonData = getEmptyDataStructure();
          originalData = JSON.parse(JSON.stringify(jsonData));

          setTimeout(() => {
            loadingIndicator.style.display = "none";
            dataContent.style.display = "block";
            renderData();
            showNotification(
              "Using empty template. Connect to server for live updates.",
              "warning"
            );
          }, 2000);
        }
      }

      // Save data to server
      async function saveData() {
        setLoading(true);
        try {
          updateMetaData();

          const response = await fetch("/api/json", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jsonData, null, 2),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Save failed");
          }

          showNotification("Data saved successfully!", "success");
          return true;
        } catch (error) {
          console.error("Failed to save:", error);
          showNotification(`Save failed: ${error.message}`, "error");
          return false;
        } finally {
          setLoading(false);
        }
      }

      // Render all data sections
      function renderData() {
        renderPersonalInfo();
        renderSkills();
        renderExperience();
        renderProjects();
      }

      // Render personal information
      function renderPersonalInfo() {
        const personal = jsonData.personal || {};
        const contact = jsonData.contact || {};

        personalInfoEl.innerHTML = `
                <div class="data-item">
                    <h3>${personal.firstName || ""} ${
          personal.lastName || ""
        } <span style="color: #00f0ff;">${personal.title || ""}</span></h3>
                    <p><strong>Tagline:</strong> ${personal.tagline || ""}</p>
                    <p><strong>Description:</strong> ${
                      personal.description || ""
                    }</p>
                    <p><strong>Date of Birth:</strong> ${
                      personal.dateOfBirth || ""
                    }</p>
                    <p><strong>Location:</strong> ${
                      personal.location?.city || ""
                    }, ${personal.location?.country || ""} ${
          personal.location?.shortCode ? `(${personal.location.shortCode})` : ""
        }</p>
                    <p><strong>Logo:</strong> ${personal.logo || ""}</p>
                    <p><strong>Email:</strong> ${contact.email || ""}</p>
                    <p><strong>GitHub:</strong> ${
                      contact.github
                        ? `<a href="${contact.github}" target="_blank">${contact.github}</a>`
                        : "Not set"
                    }</p>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editPersonalInfo()">
                            <i class="fas fa-edit"></i> Edit Personal Info
                        </button>
                    </div>
                </div>
            `;
      }

      // Render skills
      function renderSkills() {
        skillsListEl.innerHTML = "";

        const skills = jsonData.skills || [];
        skills.forEach((skill) => {
          const skillEl = document.createElement("div");
          skillEl.className = "data-item";
          skillEl.innerHTML = `
                    <h3>${
                      skill.name || ""
                    } <span style="color: #00f0ff; font-size: 0.9rem;">${
            skill.proficiency || ""
          }</span></h3>
                    <p><strong>ID:</strong> ${skill.id || ""}</p>
                    <p><strong>Description:</strong> ${
                      skill.description || ""
                    }</p>
                    ${
                      skill.yearsExperience
                        ? `<p><strong>Years Experience:</strong> ${skill.yearsExperience}</p>`
                        : ""
                    }
                    <p><strong>Logo Path:</strong> ${skill.logo || ""}</p>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editItem('skill', '${
                          skill.id
                        }')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deleteItem('skill', '${
                          skill.id
                        }')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
          skillsListEl.appendChild(skillEl);
        });

        if (skills.length === 0) {
          skillsListEl.innerHTML =
            '<div class="data-item"><p>No skills added yet.</p></div>';
        }
      }

      // Render experience
      function renderExperience() {
        experienceListEl.innerHTML = "";

        const experiences = jsonData.experience || [];
        experiences.forEach((exp) => {
          const expEl = document.createElement("div");
          expEl.className = "data-item";

          let projectsHtml = "";
          if (exp.projects && exp.projects.length > 0) {
            projectsHtml = "<p><strong>Projects:</strong></p><ul>";
            exp.projects.forEach((proj) => {
              projectsHtml += `<li>${proj.name} (${proj.startDate} - ${
                proj.endDate || "Present"
              })</li>`;
            });
            projectsHtml += "</ul>";
          }

          let responsibilitiesHtml = "";
          if (exp.responsibilities && exp.responsibilities.length > 0) {
            responsibilitiesHtml =
              "<p><strong>Responsibilities:</strong></p><ul>";
            exp.responsibilities.forEach((resp) => {
              responsibilitiesHtml += `<li>${resp}</li>`;
            });
            responsibilitiesHtml += "</ul>";
          }

          expEl.innerHTML = `
                    <h3>${exp.role || ""} at ${
            exp.company || ""
          } <span style="color: #00f0ff; font-size: 0.9rem;">${
            exp.startDate || ""
          } - ${exp.current ? "Present" : exp.endDate || ""}</span></h3>
                    <p><strong>ID:</strong> ${exp.id || ""}</p>
                    <p><strong>Summary:</strong> ${exp.summary || ""}</p>
                    ${responsibilitiesHtml}
                    ${projectsHtml}
                    <p><strong>Technologies:</strong> ${
                      exp.technologies ? exp.technologies.join(", ") : ""
                    }</p>
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editItem('experience', '${
                          exp.id
                        }')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deleteItem('experience', '${
                          exp.id
                        }')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
          experienceListEl.appendChild(expEl);
        });

        if (experiences.length === 0) {
          experienceListEl.innerHTML =
            '<div class="data-item"><p>No experience added yet.</p></div>';
        }
      }

      // Render projects
      function renderProjects() {
        projectsListEl.innerHTML = "";

        const projects = jsonData.projects || [];
        projects.forEach((project) => {
          const projectEl = document.createElement("div");
          projectEl.className = "data-item";
          projectEl.innerHTML = `
                    <h3>${project.icon || ""} ${project.title || ""} ${
            project.featured
              ? '<span style="color: #ff00aa;">(Featured)</span>'
              : ""
          }</h3>
                    <p><strong>ID:</strong> ${project.id || ""}</p>
                    <p><strong>Description:</strong> ${
                      project.description || ""
                    }</p>
                    <p><strong>Technologies:</strong> ${
                      project.technologies
                        ? project.technologies.join(", ")
                        : ""
                    }</p>
                    <p><strong>Live URL:</strong> ${
                      project.liveUrl
                        ? `<a href="${project.liveUrl}" target="_blank">${project.liveUrl}</a>`
                        : "Not set"
                    }</p>
                    ${
                      project.githubUrl
                        ? `<p><strong>GitHub:</strong> <a href="${project.githubUrl}" target="_blank">${project.githubUrl}</a></p>`
                        : ""
                    }
                    <div class="item-actions">
                        <button class="edit-btn" onclick="editItem('project', '${
                          project.id
                        }')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deleteItem('project', '${
                          project.id
                        }')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
          projectsListEl.appendChild(projectEl);
        });

        if (projects.length === 0) {
          projectsListEl.innerHTML =
            '<div class="data-item"><p>No projects added yet.</p></div>';
        }
      }

      // Show JSON data
      function showJsonData() {
        jsonOutputEl.textContent = JSON.stringify(jsonData, null, 2);
        jsonViewSection.style.display = "block";
        window.scrollTo({ top: jsonViewSection.offsetTop, behavior: "smooth" });
      }

      // Setup event listeners
      function setupEventListeners() {
        // Control panel buttons
        document
          .getElementById("viewJsonBtn")
          .addEventListener("click", showJsonData);
        document
          .getElementById("closeJsonBtn")
          .addEventListener("click", () => {
            jsonViewSection.style.display = "none";
          });

        document.getElementById("addSkillBtn").addEventListener("click", () => {
          openAddForm("skill");
        });

        document
          .getElementById("addExperienceBtn")
          .addEventListener("click", () => {
            openAddForm("experience");
          });

        document
          .getElementById("addProjectBtn")
          .addEventListener("click", () => {
            openAddForm("project");
          });

        document
          .getElementById("resetDataBtn")
          .addEventListener("click", resetData);
        document
          .getElementById("exportJsonBtn")
          .addEventListener("click", exportJson);

        // Form modal buttons
        document
          .getElementById("closeFormBtn")
          .addEventListener("click", closeForm);
        document
          .getElementById("cancelBtn")
          .addEventListener("click", closeForm);

        // Form submission
        dataForm.addEventListener("submit", handleFormSubmit);
      }

      // Open form for adding new item
      function openAddForm(dataType) {
        currentOperation = "add";
        currentDataType = dataType;
        currentItemId = "";

        formTitle.textContent = `Add ${capitalizeFirstLetter(dataType)}`;

        // Generate form fields based on data type
        let formHTML = "";

        if (dataType === "skill") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" required placeholder="e.g., javascript">
                    </div>
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" name="name" required placeholder="e.g., JavaScript / TypeScript">
                    </div>
                    <div class="form-group">
                        <label for="logo">Logo Path</label>
                        <input type="text" id="logo" name="logo" placeholder="/logo/example.png">
                    </div>
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" required placeholder="Description of the skill"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="proficiency">Proficiency *</label>
                        <select id="proficiency" name="proficiency" required>
                            <option value="">Select proficiency</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="competent">Competent</option>
                            <option value="advanced">Advanced</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="yearsExperience">Years Experience</label>
                        <input type="number" id="yearsExperience" name="yearsExperience" min="0" max="50">
                    </div>
                `;
        } else if (dataType === "experience") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" required placeholder="e.g., company-name">
                    </div>
                    <div class="form-group">
                        <label for="company">Company *</label>
                        <input type="text" id="company" name="company" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role *</label>
                        <input type="text" id="role" name="role" required>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date *</label>
                        <input type="month" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="month" id="endDate" name="endDate">
                    </div>
                    <div class="form-group">
                        <label for="current">Currently Working Here</label>
                        <input type="checkbox" id="current" name="current">
                    </div>
                    <div class="form-group">
                        <label for="summary">Summary *</label>
                        <textarea id="summary" name="summary" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="technologies">Technologies (comma separated)</label>
                        <input type="text" id="technologies" name="technologies" placeholder="React.js, TypeScript, HTML5">
                    </div>
                `;
        } else if (dataType === "project") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" required placeholder="e.g., project-name">
                    </div>
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="icon">Icon (emoji)</label>
                        <input type="text" id="icon" name="icon" placeholder="ðŸŽ®">
                    </div>
                    <div class="form-group">
                        <label for="technologies">Technologies (comma separated) *</label>
                        <input type="text" id="technologies" name="technologies" required placeholder="React.js, HTML5, CSS3">
                    </div>
                    <div class="form-group">
                        <label for="liveUrl">Live URL *</label>
                        <input type="url" id="liveUrl" name="liveUrl" required placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="githubUrl">GitHub URL</label>
                        <input type="url" id="githubUrl" name="githubUrl" placeholder="https://github.com/username/repo">
                    </div>
                    <div class="form-group">
                        <label for="featured">Featured Project</label>
                        <input type="checkbox" id="featured" name="featured">
                    </div>
                `;
        }

        formFields.innerHTML = formHTML;
        formModal.style.display = "flex";
      }

      // Open form for editing an item
      function editItem(dataType, itemId) {
        currentOperation = "edit";
        currentDataType = dataType;
        currentItemId = itemId;

        formTitle.textContent = `Edit ${capitalizeFirstLetter(dataType)}`;

        // Find the item to edit
        let item;
        if (dataType === "skill") {
          item = (jsonData.skills || []).find((skill) => skill.id === itemId);
        } else if (dataType === "experience") {
          item = (jsonData.experience || []).find((exp) => exp.id === itemId);
        } else if (dataType === "project") {
          item = (jsonData.projects || []).find((proj) => proj.id === itemId);
        }

        if (!item) {
          showNotification("Item not found!", "error");
          return;
        }

        // Generate form fields with existing data
        let formHTML = "";

        if (dataType === "skill") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" value="${
                          item.id || ""
                        }" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" name="name" value="${
                          item.name || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="logo">Logo Path</label>
                        <input type="text" id="logo" name="logo" value="${
                          item.logo || ""
                        }">
                    </div>
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" required>${
                          item.description || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label for="proficiency">Proficiency *</label>
                        <select id="proficiency" name="proficiency" required>
                            <option value="beginner" ${
                              item.proficiency === "beginner" ? "selected" : ""
                            }>Beginner</option>
                            <option value="intermediate" ${
                              item.proficiency === "intermediate"
                                ? "selected"
                                : ""
                            }>Intermediate</option>
                            <option value="competent" ${
                              item.proficiency === "competent" ? "selected" : ""
                            }>Competent</option>
                            <option value="advanced" ${
                              item.proficiency === "advanced" ? "selected" : ""
                            }>Advanced</option>
                            <option value="expert" ${
                              item.proficiency === "expert" ? "selected" : ""
                            }>Expert</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="yearsExperience">Years Experience</label>
                        <input type="number" id="yearsExperience" name="yearsExperience" value="${
                          item.yearsExperience || ""
                        }" min="0" max="50">
                    </div>
                `;
        } else if (dataType === "experience") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" value="${
                          item.id || ""
                        }" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="company">Company *</label>
                        <input type="text" id="company" name="company" value="${
                          item.company || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role *</label>
                        <input type="text" id="role" name="role" value="${
                          item.role || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date *</label>
                        <input type="month" id="startDate" name="startDate" value="${
                          item.startDate || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="month" id="endDate" name="endDate" value="${
                          item.endDate || ""
                        }">
                    </div>
                    <div class="form-group">
                        <label for="current">Currently Working Here</label>
                        <input type="checkbox" id="current" name="current" ${
                          item.current ? "checked" : ""
                        }>
                    </div>
                    <div class="form-group">
                        <label for="summary">Summary *</label>
                        <textarea id="summary" name="summary" required>${
                          item.summary || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label for="technologies">Technologies (comma separated)</label>
                        <input type="text" id="technologies" name="technologies" value="${
                          item.technologies ? item.technologies.join(", ") : ""
                        }">
                    </div>
                `;
        } else if (dataType === "project") {
          formHTML = `
                    <div class="form-group">
                        <label for="id">ID *</label>
                        <input type="text" id="id" name="id" value="${
                          item.id || ""
                        }" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" value="${
                          item.title || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" required>${
                          item.description || ""
                        }</textarea>
                    </div>
                    <div class="form-group">
                        <label for="icon">Icon (emoji)</label>
                        <input type="text" id="icon" name="icon" value="${
                          item.icon || ""
                        }">
                    </div>
                    <div class="form-group">
                        <label for="technologies">Technologies (comma separated) *</label>
                        <input type="text" id="technologies" name="technologies" value="${
                          item.technologies ? item.technologies.join(", ") : ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="liveUrl">Live URL *</label>
                        <input type="url" id="liveUrl" name="liveUrl" value="${
                          item.liveUrl || ""
                        }" required>
                    </div>
                    <div class="form-group">
                        <label for="githubUrl">GitHub URL</label>
                        <input type="url" id="githubUrl" name="githubUrl" value="${
                          item.githubUrl || ""
                        }">
                    </div>
                    <div class="form-group">
                        <label for="featured">Featured Project</label>
                        <input type="checkbox" id="featured" name="featured" ${
                          item.featured ? "checked" : ""
                        }>
                    </div>
                `;
        }

        formFields.innerHTML = formHTML;
        formModal.style.display = "flex";
      }

      // Edit personal information
      function editPersonalInfo() {
        currentOperation = "edit";
        currentDataType = "personal";

        formTitle.textContent = "Edit Personal Information";

        const personal = jsonData.personal || {};
        const contact = jsonData.contact || {};

        formFields.innerHTML = `
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" value="${
                      personal.firstName || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" value="${
                      personal.lastName || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" value="${
                      personal.title || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="tagline">Tagline *</label>
                    <input type="text" id="tagline" name="tagline" value="${
                      personal.tagline || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" required>${
                      personal.description || ""
                    }</textarea>
                </div>
                <div class="form-group">
                    <label for="dateOfBirth">Date of Birth *</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth" value="${
                      personal.dateOfBirth || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="city">City *</label>
                    <input type="text" id="city" name="city" value="${
                      personal.location?.city || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="country">Country *</label>
                    <input type="text" id="country" name="country" value="${
                      personal.location?.country || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="shortCode">Short Code</label>
                    <input type="text" id="shortCode" name="shortCode" value="${
                      personal.location?.shortCode || ""
                    }">
                </div>
                <div class="form-group">
                    <label for="logo">Logo</label>
                    <input type="text" id="logo" name="logo" value="${
                      personal.logo || ""
                    }">
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" value="${
                      contact.email || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="github">GitHub URL *</label>
                    <input type="url" id="github" name="github" value="${
                      contact.github || ""
                    }" required>
                </div>
                <div class="form-group">
                    <label for="linkedin">LinkedIn URL</label>
                    <input type="url" id="linkedin" name="linkedin" value="${
                      contact.linkedin || ""
                    }">
                </div>
                <div class="form-group">
                    <label for="website">Website URL</label>
                    <input type="url" id="website" name="website" value="${
                      contact.website || ""
                    }">
                </div>
            `;

        formModal.style.display = "flex";
      }

      // Handle form submission
      async function handleFormSubmit(e) {
        e.preventDefault();

        const formData = new FormData(dataForm);
        const data = Object.fromEntries(formData.entries());

        // Handle checkboxes
        if (currentDataType === "experience") {
          data.current = document.getElementById("current")?.checked || false;
        } else if (currentDataType === "project") {
          data.featured = document.getElementById("featured")?.checked || false;
        }

        // Process technologies field
        if (data.technologies) {
          data.technologies = data.technologies
            .split(",")
            .map((tech) => tech.trim())
            .filter((tech) => tech);
        } else if (currentDataType === "project") {
          data.technologies = [];
        }

        // Handle empty string conversion to null for optional fields
        Object.keys(data).forEach((key) => {
          if (data[key] === "") {
            // Don't convert required fields to null
            if (
              ![
                "id",
                "name",
                "description",
                "proficiency",
                "company",
                "role",
                "startDate",
                "summary",
                "title",
                "liveUrl",
                "technologies",
                "firstName",
                "lastName",
                "tagline",
                "email",
                "github",
              ].includes(key)
            ) {
              data[key] = null;
            }
          }
        });

        if (currentOperation === "add") {
          await addItem(data);
        } else {
          await updateItem(data);
        }

        closeForm();
      }

      // Add a new item
      async function addItem(data) {
        try {
          if (currentDataType === "skill") {
            if (!jsonData.skills) jsonData.skills = [];

            // Check if skill with this ID already exists
            if (jsonData.skills.find((skill) => skill.id === data.id)) {
              showNotification("A skill with this ID already exists!", "error");
              return;
            }

            jsonData.skills.push(data);
            showNotification("Skill added successfully!", "success");
          } else if (currentDataType === "experience") {
            if (!jsonData.experience) jsonData.experience = [];

            // Check if experience with this ID already exists
            if (jsonData.experience.find((exp) => exp.id === data.id)) {
              showNotification(
                "An experience with this ID already exists!",
                "error"
              );
              return;
            }

            // Add empty arrays for projects and responsibilities
            data.projects = [];
            data.responsibilities = [];

            jsonData.experience.push(data);
            showNotification("Experience added successfully!", "success");
          } else if (currentDataType === "project") {
            if (!jsonData.projects) jsonData.projects = [];

            // Check if project with this ID already exists
            if (jsonData.projects.find((proj) => proj.id === data.id)) {
              showNotification(
                "A project with this ID already exists!",
                "error"
              );
              return;
            }

            jsonData.projects.push(data);
            showNotification("Project added successfully!", "success");
          }

          renderData();
          await saveData();
        } catch (error) {
          console.error("Error adding item:", error);
          showNotification("Failed to add item", "error");
        }
      }

      // Update an existing item
      async function updateItem(data) {
        try {
          if (currentDataType === "personal") {
            // Initialize if not exists
            if (!jsonData.personal) jsonData.personal = {};
            if (!jsonData.personal.location) jsonData.personal.location = {};
            if (!jsonData.contact) jsonData.contact = {};

            // Update personal info
            jsonData.personal.firstName = data.firstName;
            jsonData.personal.lastName = data.lastName;
            jsonData.personal.title = data.title;
            jsonData.personal.tagline = data.tagline;
            jsonData.personal.description = data.description;
            jsonData.personal.dateOfBirth = data.dateOfBirth;
            jsonData.personal.location.city = data.city;
            jsonData.personal.location.country = data.country;
            jsonData.personal.location.shortCode = data.shortCode;
            jsonData.personal.logo = data.logo;

            // Update contact info
            jsonData.contact.email = data.email;
            jsonData.contact.github = data.github;
            jsonData.contact.linkedin = data.linkedin;
            jsonData.contact.website = data.website;

            showNotification(
              "Personal information updated successfully!",
              "success"
            );
          } else if (currentDataType === "skill") {
            if (!jsonData.skills) jsonData.skills = [];

            const index = jsonData.skills.findIndex(
              (skill) => skill.id === currentItemId
            );
            if (index !== -1) {
              // Preserve the original ID
              data.id = currentItemId;
              jsonData.skills[index] = data;
              showNotification("Skill updated successfully!", "success");
            } else {
              showNotification("Skill not found!", "error");
              return;
            }
          } else if (currentDataType === "experience") {
            if (!jsonData.experience) jsonData.experience = [];

            const index = jsonData.experience.findIndex(
              (exp) => exp.id === currentItemId
            );
            if (index !== -1) {
              // Preserve the original ID and existing projects/responsibilities
              data.id = currentItemId;
              data.projects = jsonData.experience[index].projects || [];
              data.responsibilities =
                jsonData.experience[index].responsibilities || [];
              jsonData.experience[index] = data;
              showNotification("Experience updated successfully!", "success");
            } else {
              showNotification("Experience not found!", "error");
              return;
            }
          } else if (currentDataType === "project") {
            if (!jsonData.projects) jsonData.projects = [];

            const index = jsonData.projects.findIndex(
              (proj) => proj.id === currentItemId
            );
            if (index !== -1) {
              // Preserve the original ID
              data.id = currentItemId;
              jsonData.projects[index] = data;
              showNotification("Project updated successfully!", "success");
            } else {
              showNotification("Project not found!", "error");
              return;
            }
          }

          renderData();
          await saveData();
        } catch (error) {
          console.error("Error updating item:", error);
          showNotification("Failed to update item", "error");
        }
      }

      // Delete an item
      async function deleteItem(dataType, itemId) {
        if (!confirm(`Are you sure you want to delete this ${dataType}?`)) {
          return;
        }

        try {
          let deleted = false;

          if (dataType === "skill") {
            if (jsonData.skills) {
              const index = jsonData.skills.findIndex(
                (skill) => skill.id === itemId
              );
              if (index !== -1) {
                jsonData.skills.splice(index, 1);
                deleted = true;
              }
            }
          } else if (dataType === "experience") {
            if (jsonData.experience) {
              const index = jsonData.experience.findIndex(
                (exp) => exp.id === itemId
              );
              if (index !== -1) {
                jsonData.experience.splice(index, 1);
                deleted = true;
              }
            }
          } else if (dataType === "project") {
            if (jsonData.projects) {
              const index = jsonData.projects.findIndex(
                (proj) => proj.id === itemId
              );
              if (index !== -1) {
                jsonData.projects.splice(index, 1);
                deleted = true;
              }
            }
          }

          if (deleted) {
            renderData();
            await saveData();
            showNotification(
              `${capitalizeFirstLetter(dataType)} deleted successfully!`,
              "success"
            );
          } else {
            showNotification(
              `${capitalizeFirstLetter(dataType)} not found!`,
              "error"
            );
          }
        } catch (error) {
          console.error("Error deleting item:", error);
          showNotification("Failed to delete item", "error");
        }
      }

      // Reset data to original
      async function resetData() {
        if (
          !confirm(
            "Are you sure you want to reset all changes? This cannot be undone."
          )
        ) {
          return;
        }

        try {
          jsonData = JSON.parse(JSON.stringify(originalData));
          renderData();
          await saveData();
          showNotification("Data reset to original values!", "success");
        } catch (error) {
          console.error("Error resetting data:", error);
          showNotification("Failed to reset data", "error");
        }
      }

      // Export JSON data
      function exportJson() {
        const dataStr = JSON.stringify(jsonData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });

        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "resume-data.json";
        link.click();

        URL.revokeObjectURL(url);
        showNotification("JSON exported successfully!", "success");
      }

      // Update metadata
      function updateMetaData() {
        if (!jsonData.meta) jsonData.meta = {};
        const now = new Date();
        jsonData.meta.lastUpdated = now.toISOString().split("T")[0];
        if (!jsonData.meta.version) jsonData.meta.version = "1.0.0";
      }

      // Close form modal
      function closeForm() {
        formModal.style.display = "none";
        dataForm.reset();
      }

      // Show notification
      function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = "block";

        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      }

      // Set loading state
      function setLoading(isLoading) {
        const buttons = document.querySelectorAll("button");
        buttons.forEach((btn) => {
          if (
            !btn.id ||
            !["cancelBtn", "closeFormBtn", "closeJsonBtn"].includes(btn.id)
          ) {
            btn.disabled = isLoading;
          }
        });
      }

      // Get empty data structure
      function getEmptyDataStructure() {
        return {
          personal: {
            firstName: "",
            lastName: "",
            title: "",
            tagline: "",
            description: "",
            dateOfBirth: "",
            location: {
              city: "",
              country: "",
              shortCode: "",
            },
            avatar: null,
            logo: "",
          },
          contact: {
            email: "",
            github: "",
            linkedin: null,
            website: null,
          },
          skills: [],
          experience: [],
          education: [],
          languages: [],
          highlights: [],
          projects: [],
          navigation: [],
          meta: {
            version: "1.0.0",
            lastUpdated: new Date().toISOString().split("T")[0],
          },
        };
      }

      // Helper function to capitalize first letter
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }

      // Make functions available globally for onclick handlers
      window.editPersonalInfo = editPersonalInfo;
      window.editItem = editItem;
      window.deleteItem = deleteItem;
    </script>
  </body>
</html>
